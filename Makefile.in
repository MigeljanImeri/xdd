#
# This program is free software; you can redistribute it and/or modify 
# it under the terms of the GNU General Public License as published by 
# the Free Software Foundation; either version 2 of the License, or 
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful, but 
# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY 
# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License 
# for more details.
# 
# You should have received a copy of the GNU General Public License along 
# with this program; if not, write to the Free Software Foundation, Inc., 
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
#
#
# This file is part of XDD
#
# Description: XDD Makefile
#

#
# Make all the default goal
#
.DEFAULT_GOAL: all

all:

#
# Autoconf provided values
#
VERSION := @PACKAGE_VERSION@
XDD_DIR := @CONFIG_PROJECT_DIR@
BUILD_DIR := @CONFIG_BUILD_DIR@
INSTALL_DIR := @prefix@
CC_EXE := @CC@
DEPC_EXE := @DEPC_PATH@
TAR_EXE := @TAR@
PATCH_EXE := @PATCH@
PYTHON_EXE := @PYTHON_BIN@
CP_PRESERVE_OPTS := @CP_PRESERVE_OPTS@
ECDSA_DIST := @ECDSA_DIST@
PYCRYPTO_DIST := @PYCRYPTO_DIST@
XDDCP_ENABLED := @XDDCP_ENABLED@
XDDMCP_ENABLED := @XDDMCP_ENABLED@

PYTHON_SITE_DIR := $(INSTALL_DIR)/lib/@PYTHON_LIB@/site-packages

#
# Configuration
#
SHELL =	/bin/sh
OS = $(shell uname)
HOST = $(shell echo $(hostname) | cut -d '.' -f 1)

#
# Source locations
#
DOC_DIR = doc
LIB_DIR = lib
SRC_DIR = src
HDR_DIR = include
TESTS_DIR = tests
BASE_DIR = $(SRC_DIR)/base
BX_DIR = $(SRC_DIR)/bx
CLIENT_DIR = $(SRC_DIR)/client
COMMON_DIR = $(SRC_DIR)/common
COMPAT_DIR = $(SRC_DIR)/compat
CONTRIB_DIR = contrib
FS_DIR = $(SRC_DIR)/fs
NET_DIR = $(SRC_DIR)/net
XNET_DIR = $(SRC_DIR)/xnet
PUBLIC_DIR = $(SRC_DIR)/public
TOOLS_DIR = $(SRC_DIR)/tools
TOOLS_PYTHON_DIR = $(SRC_DIR)/tools/python
TOOLS_UTILS_DIR = $(SRC_DIR)/tools/utils
XNI_DIR = $(SRC_DIR)/xni

#
# Tools
#
AR = ar
AUTOCONF = autoconf
CC = $(CC_EXE)
CP = cp
CPR = cp -r $(CP_PRESERVE_OPTS)
DEPC = $(DEPC_EXE)
DEPGEN = $(XDD_DIR)/support/depend.sh
ETAGS = etags
FIND = find
INSTALL = $(XDD_DIR)/support/install-sh
LD = $(CC_EXE)
LN = ln -sf
MKDIR = mkdir -p
MPICC = mpicc
MV = mv -f
PATCH = $(PATCH_EXE)
PYTHON = PYTHONPATH=$(TOOLS_PYTHON_DIR):$(XDD_DIR)/contrib/site-packages:$(PYTHONPATH) $(PYTHON_EXE)
PYC = $(PYTHON_EXE) -m compileall -f -b
RM = rm -f
RMDIR = rmdir
TAR = $(TAR_EXE)
QUIET_COMPILE = 1
# configure default is silent. Allow silence to be overriden with
# make V=1
ifdef V
	QUIET_COMPILE = 0
endif

ifeq ($(QUIET_COMPILE),1)
	# say a one-line description of the action, do not echo the command
	Q=@echo
	E=@
else
	# do not say short Q lines, but do echo the entire command
	Q=@echo >/dev/null
	E=
endif

#
# Include module makefiles
#
include $(BASE_DIR)/module.mk
include $(BX_DIR)/module.mk
include $(CLIENT_DIR)/module.mk
include $(COMMON_DIR)/module.mk
include $(COMPAT_DIR)/module.mk
include $(FS_DIR)/module.mk
include $(NET_DIR)/module.mk
include $(PUBLIC_DIR)/module.mk
include $(XNI_DIR)/module.mk
include $(XNET_DIR)/module.mk

#
# Construct information from modules
#
XDD_SRC := $(BASE_SRC) $(CLIENT_SRC) $(COMMON_SRC) \
	$(COMPAT_SRC) $(FS_SRC) $(NET_SRC) $(PUBLIC_SRC) \
	$(XNI_SRC) $(XNET_SRC)

#
# XDD module build targets
#
XDD_OBJS := $(patsubst %.c, %.o, $(filter %.c, $(XDD_SRC)))

#
# Project executable objects
#
XDD_EXE_OBJS := $(patsubst %.c, %.o, $(filter %.c, $(XDD_EXE_SRC)))

#
# All objects
#
ALL_OBJS = \
	$(XDD_OBJS) \
	$(CLIENT_EXE_OBJS) \
	$(XDD_EXE_OBJS)

#
# Source code dependency generation
#
XDD_DEPENDS := $(patsubst %.c, %.d, $(filter %.c, $(XDD_SRC)))
XDD_EXE_DEPENDS := $(patsubst %.c, %.d, $(filter %.c, $(CLIENT_EXE_SRC)))

#
# Default build settings
#
INCLUDES = -I$(BASE_DIR) -I$(CLIENT_DIR) -I$(COMMON_DIR) \
		-I$(COMPAT_DIR) -I$(FS_DIR) -I$(NET_DIR) \
		-I$(PUBLIC_DIR) -I$(XNI_DIR)

ARFLAGS = @CONFIG_ARFLAGS@

CPPFLAGS = @CONFIG_CPPFLAGS@ \
	@DEFS@ \
	$(CONFIDENCE_ENABLED) \
	$(INCLUDES)

CFLAGS =  @CONFIG_CFLAGS@

LDFLAGS = @CONFIG_LDFLAGS@ 

LIBS = @CONFIG_LIBS@

#
# Build rules
#
all: xdd 

xdd: bin/xdd

.PHONY: all xdd

#
# Build rules for executable targets
#
bin/xdd: $(XDD_OBJS) $(XDD_EXE_OBJS)
	$(Q) "[LD] $@ ..."
	$(E)$(LD) $(LDFLAGS) -o $@ $^ $(LIBS)

#
# Build rules for installation
#

fastinstall: all
	$(RM) /sbin/xdd
	cp bin/xdd /sbin

install_xdd:
	$(INSTALL) -c -m 755 bin/xdd $(INSTALL_DIR)/bin/xdd

install: all install_xdd 

.PHONY: install install_xdd

check:
	./tests/run_tests.sh

.PHONY: check

#
# Miscellaneous build rules
#
XDDVERSION := $(VERSION)
baseversion:
	echo "#define XDD_BASE_VERSION $(XDDVERSION)" > $(BASE_DIR)/xdd_base_version.h

TARPATH := $(shell basename ${PWD})
TARFILE := xdd-$(shell date +%s).tgz
TARFLAGS := --exclude \*.o --exclude \*~ --exclude .DS_STORE --exclude .git
tarball:
	@echo "[TAR] $(TARFILE)"
	@pushd .; cd .. && $(TAR) $(TARFLAGS) -czf $(TARFILE) $(TARPATH); popd

.PHONY: baseversion dist fulldist tarball

#
# Build rules for documentation
#
doc:
	doxygen doc/Doxyfile
	cd doc/doxygen/latex && make pdf

TAGS: $(XDD_SRC)
	@echo "[TAGS]"
	@$(ETAGS) $^

#
# Build rules for cleaning up derived files
#
testclean:

depclean:
	$(info Cleaning the $(OS) dependency files )
	@$(RM) $(XDD_DEPENDS) $(TOOLS_DEPENDS)

docclean:
	$(info Cleaning the $(OS) documentation files )
	@$(RM) -r doc/doxygen

libclean:
	$(info Cleaning the $(OS) LIBRARY files )
	@$(RM) $(LIB_DIR)/libxdd.*

oclean:
	$(info Cleaning the $(OS) OBJECT files )
	@$(RM) $(ALL_OBJS) 

tclean: 
	$(info Cleaning the $(OS) TOOLS OBJECT files )
	@$(RM) src/tools/*.o


clean: depclean libclean oclean tclean
	$(info Cleaning the $(OS) executable files )
	@$(RM) 	bin/xdd \
	 	bin/xdd-lite \
		bin/xdd-tserver\
		bin/xdd-getfilesize \
		bin/xdd-gethostip \
		bin/xdd-gettime \
		bin/xdd-read-tsdumps \
		bin/xdd-truncate \
		bin/xdd-read-tsdumps \
		bin/bxt \
		a.out 

.PHONY: testclean depclean docclean libclean oclean clean

#
# Rules for building the distribution
#
DISTCHECK_DIR := $(PWD)/tests/distcheck
CONFIG_FLAGS = $(shell grep "\-\-prefix" config.log | cut -f 5- -d ' ')

xdd-$(XDDVERSION):
	git archive --format=tar --prefix=$@/ xdd-2.0 | $(TAR) xf -
	$(FIND) $@ -name .gitignore -exec rm {} \;
	cd $@ && $(AUTOCONF)

xdd-$(XDDVERSION).tar.gz: xdd-$(XDDVERSION)
	$(TAR) cfz $@ $<
	@$(RM) -r $<

xdd-$(XDDVERSION)+export-control.tar.gz: xdd-$(XDDVERSION)
	$(CP) ~/Downloads/ecdsa-0.11.tar.gz $</contrib
	$(CP) ~/Downloads/pycrypto-2.6.1.tar.gz $</contrib
	$(TAR) cfz $@ $<
	$(RM) -r $<

distclean: clean
	$(info Cleaning the distribution)
	@$(RM) GNUMakefile
	@$(RM) Makefile
	@$(RM) config.log config.status
	@$(RM) -r xdd-$(VERSION)
	@$(RM) xdd-$(VERSION).tar.gz

distcheck: dist
	$(RM) -r $(DISTCHECK_DIR)
	$(MKDIR) $(DISTCHECK_DIR)
	$(TAR) -C $(DISTCHECK_DIR) -xzf xdd-$(XDDVERSION).tar.gz
	cd $(DISTCHECK_DIR)/xdd-$(XDDVERSION) && ./configure $(CONFIG_FLAGS) --prefix=$(DISTCHECK_DIR)
	cd $(DISTCHECK_DIR)/xdd-$(XDDVERSION) && make
	cd $(DISTCHECK_DIR)/xdd-$(XDDVERSION) && make check
	cd $(DISTCHECK_DIR)/xdd-$(XDDVERSION) && make install

dist: xdd-$(XDDVERSION).tar.gz 

dist-usa: xdd-$(XDDVERSION)+export-control.tar.gz

.PHONY: dist dist-usa distcheck distclean

#
# Include dependency makefiles if building source target
#
DEPFILTER_MAKECMDGOALS := $(filter %clean %doc, $(MAKECMDGOALS))
ifeq ($(strip $(DEPFILTER_MAKECMDGOALS)),)
-include $(XDD_DEPENDS)
#-include $(TOOLS_DEPENDS)
endif

#
# Overload default rules so that compilation is prettier
#
%.o: %.c
	$(Q) "[CC] $< . . ."
	$(E)$(CC) -c $(CPPFLAGS) $(CFLAGS) $< -o $@
#
# Additional rule for building dependencies
#
%.d: %.c
	$(Q) "[DEPC] $< . . ."
	@mkdir -p $(shell dirname $@)
	$(E)$(DEPGEN) $(shell dirname $<) $(DEPC) -MM $(INCLUDES) $< > $@

